(()=>{"use strict";var t="instagramHistory";function e(){return new Promise((function(e,n){var r=indexedDB.open("InstagramURLTrackerDB",1);r.onupgradeneeded=function(e){var n=e.target.result;n.objectStoreNames.contains(t)||n.createObjectStore(t,{keyPath:"id",autoIncrement:!0})},r.onsuccess=function(t){e(t.target.result)},r.onerror=function(t){n(t.target.error)}}))}if(void 0===n)var n=chrome;document.addEventListener("DOMContentLoaded",(function(){var n,r,o=0,a=new Worker("worker.js"),i="all";function c(){document.getElementById("historyTableBody").innerHTML='\n            <div class="empty-state">\n                <div class="loading"></div>\n                <div class="empty-state-text">Loading your Instagram history...</div>\n            </div>\n        ',("favorites"===i?e().then((function(e){return new Promise((function(n,r){var o=e.transaction([t],"readonly").objectStore(t).getAll();o.onsuccess=function(t){var e=t.target.result.filter((function(t){return t.favorite}));n(e)},o.onerror=function(t){r(t.target.error)}}))})):e().then((function(e){return new Promise((function(n,r){var o=e.transaction([t],"readonly").objectStore(t).getAll();o.onsuccess=function(t){n(t.target.result)},o.onerror=function(t){r(t.target.error)}}))}))).then((function(t){var e,n,r,o,c,s=function(t){var e=new Set;return t.filter((function(t){return!e.has(t.url)&&(e.add(t.url),!0)}))}(t);0===s.length?(e=document.getElementById("historyTableBody"),r=(n="favorites"===i)?"No favorite posts yet":"No Instagram posts tracked yet",o=n?"Start favoriting posts to see them here":"Visit Instagram posts to start tracking your history",c=n?"‚ù§Ô∏è":"üì∏",e.innerHTML='\n            <div class="empty-state">\n                <div class="empty-state-icon">'.concat(c,'</div>\n                <div class="empty-state-text">').concat(r,'</div>\n                <div class="empty-state-subtext">').concat(o,"</div>\n            </div>\n        ")):a.postMessage({action:"groupItemsByDate",data:s})})).catch((function(t){console.error("Error loading history:",t),document.getElementById("historyTableBody").innerHTML='\n            <div class="empty-state">\n                <div class="empty-state-icon">‚ö†Ô∏è</div>\n                <div class="empty-state-text">Error loading history</div>\n                <div class="empty-state-subtext">Please try refreshing the extension</div>\n            </div>\n        '}))}a.onmessage=function(n){var r=n.data,a=r.action,s=r.groupedData;if("groupedData"===a){var d=document.getElementById("historyTableBody");d.innerHTML="";var l=s.reverse(),u=Math.ceil(l.length/9);o>=u&&(o=u-1),o<0&&(o=0),l.slice(9*o,9*(o+1)).forEach((function(n){var r=n.date,a=n.items,s=document.createElement("div");s.className="date-header",s.textContent=r,d.appendChild(s);var l=document.createElement("div");l.className="grid-container",a.reverse().forEach((function(n){var r=document.createElement("div");r.className="thumbnail-item",r.innerHTML='\n                        <img src="'.concat(n.thumbnail,'" alt="Thumbnail" title="').concat(n.timestamp,'" class="thumbnail">\n                        <div class="favorite-icon ').concat(n.favorite?"":"not-favorite",'" data-id="').concat(n.id,'">\n                            <svg viewBox="0 0 24 24">\n                                <path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/>\n                            </svg>\n                        </div>\n                    '),r.addEventListener("click",(function(t){t.target.closest(".favorite-icon")||window.open(n.url,"_blank")}));var a=r.querySelector(".favorite-icon");a.addEventListener("click",(function(r){r.stopPropagation(),function(n,r){(function(n){return e().then((function(e){return new Promise((function(r,o){var a=e.transaction([t],"readwrite").objectStore(t),i=a.get(n);i.onsuccess=function(){var t=i.result;if(t){t.favorite=!t.favorite;var e=a.put(t);e.onsuccess=function(){r(t.favorite)},e.onerror=function(t){o(t.target.error)}}else o(new Error("Item not found"))},i.onerror=function(t){o(t.target.error)}}))}))})(n).then((function(t){t?r.classList.remove("not-favorite"):r.classList.add("not-favorite"),"favorites"!==i||t||(o=0,c())})).catch((function(t){console.error("Error toggling favorite:",t)}))}(n.id,a)})),l.appendChild(r)})),d.appendChild(l)})),function(t){var e=document.getElementById("paginationControls");if(e.innerHTML="",!(t<=1)){var n=document.createElement("button");n.textContent="‚Üê Previous",n.disabled=0===o,n.addEventListener("click",(function(){o--,c()}));var r=document.createElement("button");r.textContent="Next ‚Üí",r.disabled=o>=t-1,r.addEventListener("click",(function(){o++,c()})),e.appendChild(n),e.appendChild(r)}}(u)}},document.getElementById("clearHistory").addEventListener("click",(function(){if(confirm("Are you sure you want to clear all Instagram history? This action cannot be undone.")){var n=document.getElementById("clearHistory"),r=n.textContent;n.textContent="Clearing...",n.disabled=!0,e().then((function(e){return new Promise((function(n,r){var o=e.transaction([t],"readwrite").objectStore(t).clear();o.onsuccess=function(){n()},o.onerror=function(t){r(t.target.error)}}))})).then((function(){o=0,c(),n.textContent=r,n.disabled=!1})).catch((function(t){console.error("Error clearing history:",t),n.textContent=r,n.disabled=!1,alert("Error clearing history. Please try again.")}))}})),n=document.getElementById("allTab"),r=document.getElementById("favoritesTab"),n.addEventListener("click",(function(){"all"!==i&&(i="all",o=0,n.classList.add("active"),r.classList.remove("active"),c())})),r.addEventListener("click",(function(){"favorites"!==i&&(i="favorites",o=0,r.classList.add("active"),n.classList.remove("active"),c())})),e().then((function(e){return new Promise((function(n,r){var o=e.transaction([t],"readwrite").objectStore(t),a=o.getAll();a.onsuccess=function(t){var e=t.target.result,r=0;e.forEach((function(t){void 0===t.favorite&&(t.favorite=!1,o.put(t),r++)})),console.log("Migrated ".concat(r," items with favorite field")),n(r)},a.onerror=function(t){r(t.target.error)}}))})).then((function(){c()})).catch((function(t){console.error("Error during migration:",t),c()}))}))})();